<script>
  const elStatus = document.getElementById("statusBox");
  const elId = document.getElementById("assetId");
  const elTyp = document.getElementById("typ");
  const elWll = document.getElementById("wll");
  const elLetzte = document.getElementById("letzte");
  const elNaechste = document.getElementById("naechste");

  function setStatus(statusRaw) {
    const s = (statusRaw || "").toString().trim().toLowerCase();

    // Mapping DE -> intern
    let status = "blocked";
    if (s === "ok") status = "ok";
    else if (s === "fÃ¤llig" || s === "faellig") status = "due";
    else if (s === "gesperrt") status = "blocked";

    elStatus.classList.remove("ok", "bad");

    if (status === "ok") {
      elStatus.classList.add("ok");
      elStatus.textContent = "ðŸŸ¢ Betriebssicher";
    } else if (status === "due") {
      elStatus.classList.add("bad"); // wenn du gelb willst: sag Bescheid, ich ergÃ¤nze CSS
      elStatus.textContent = "ðŸŸ¡ PrÃ¼fung fÃ¤llig";
    } else {
      elStatus.classList.add("bad");
      elStatus.textContent = "ðŸ”´ Gesperrt";
    }
  }

  // CSV Utilities
  function detectDelimiter(headerLine) {
    const semi = (headerLine.match(/;/g) || []).length;
    const comma = (headerLine.match(/,/g) || []).length;
    return semi > comma ? ";" : ",";
  }

  function splitCSVLine(line, delimiter) {
    const result = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const ch = line[i];

      if (ch === '"') {
        if (inQuotes && line[i + 1] === '"') { cur += '"'; i++; }
        else inQuotes = !inQuotes;
      } else if (ch === delimiter && !inQuotes) {
        result.push(cur);
        cur = "";
      } else {
        cur += ch;
      }
    }
    result.push(cur);
    return result;
  }

  function normalizeHeader(h) {
    return (h || "")
      .toString()
      .trim()
      .toLowerCase()
      .replace(/\s+/g, " ")
      .replace(/-+/g, "-");
  }

  function parseCSV(text) {
    const cleaned = text.replace(/\r/g, "").replace(/^\uFEFF/, ""); // BOM weg
    const lines = cleaned.split("\n").map(l => l.trim()).filter(Boolean);
    if (lines.length < 2) return { rows: [], headers: [], delimiter: "," };

    const delimiter = detectDelimiter(lines[0]);
    const headersRaw = splitCSVLine(lines[0], delimiter).map(h => h.trim());
    const headers = headersRaw.map(normalizeHeader);

    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      const cols = splitCSVLine(lines[i], delimiter);
      const obj = {};
      headers.forEach((h, idx) => obj[h] = (cols[idx] ?? "").trim());
      rows.push(obj);
    }
    return { rows, headers, delimiter };
  }

  function getField(row, possibleHeaders) {
    for (const h of possibleHeaders) {
      const key = normalizeHeader(h);
      if (row[key] !== undefined && row[key] !== "") return row[key];
    }
    return "";
  }

  async function main() {
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");

    if (!id) {
      elId.textContent = "â€”";
      elTyp.textContent = "Bitte URL mit ?id=... Ã¶ffnen";
      elWll.textContent = "â€”";
      elLetzte.textContent = "â€”";
      elNaechste.textContent = "â€”";
      setStatus("fÃ¤llig");
      return;
    }

    elId.textContent = id;

    try {
      const res = await fetch("assets.csv?ts=" + Date.now());
      if (!res.ok) throw new Error("assets.csv nicht gefunden");

      const csvText = await res.text();
      const { rows } = parseCSV(csvText);

      // Deine Spaltennamen (mit Varianten)
      const idHeaders = ["Serviceartikel-NR", "Serviceartikel-Nr.", "Serviceartikel-Nr", "Serviceartikel-NR."];
      const statusHeaders = ["status"];
      const typHeaders = ["typ", "Anschlagmittel"];
      const wllHeaders = ["TragfÃ¤higkeit", "Tragfaehigkeit", "WLL", "TragfÃ¤higkeit (WLL)"];
      const letzteHeaders = ["letzte PrÃ¼fung", "letzte pruefung", "Letzte PrÃ¼fung"];
      const naechsteHeaders = ["nÃ¤chste PrÃ¼fung", "naechste pruefung", "NÃ¤chste PrÃ¼fung"];

      const asset = rows.find(r => getField(r, idHeaders).trim() === id);

      if (!asset) {
        elTyp.textContent = "Unbekannt (ID nicht gefunden)";
        elWll.textContent = "â€”";
        elLetzte.textContent = "â€”";
        elNaechste.textContent = "â€”";
        setStatus("gesperrt");
        return;
      }

      elTyp.textContent = getField(asset, typHeaders) || "â€”";
      elWll.textContent = getField(asset, wllHeaders) || "â€”";
      elLetzte.textContent = getField(asset, letzteHeaders) || "â€”";
      elNaechste.textContent = getField(asset, naechsteHeaders) || "â€”";
      setStatus(getField(asset, statusHeaders));

    } catch (e) {
      elTyp.textContent = "Fehler beim Laden der CSV";
      elWll.textContent = "â€”";
      elLetzte.textContent = "â€”";
      elNaechste.textContent = "â€”";
      setStatus("gesperrt");
      console.error(e);
    }
  }

  main();
</script>
