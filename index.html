<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Digitale PrÃ¼fplakette</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 0;
    }
    .card {
      max-width: 420px;
      margin: 30px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 20px;
    }
    .status {
      font-size: 22px;
      font-weight: bold;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 20px;
    }
    .ok { background: #e6f4ea; color: #137333; }
    .bad { background: #fdecea; color: #a50e0e; }

    .row { margin-bottom: 10px; }
    .label { color: #666; font-size: 14px; }
    .value { font-size: 16px; }

    footer {
      margin-top: 20px;
      font-size: 12px;
      color: #888;
      text-align: center;
    }
  </style>
</head>
<body>

<div class="card">
  <div class="status ok" id="statusBox">ðŸŸ¢ Betriebssicher</div>

  <div class="row">
    <div class="label">Anschlagmittel</div>
    <div class="value" id="typ">â€”</div>
  </div>

  <div class="row">
    <div class="label">TragfÃ¤higkeit (WLL)</div>
    <div class="value" id="wll">â€”</div>
  </div>

  <div class="row">
    <div class="label">Serviceartikel-Nr.</div>
    <div class="value" id="assetId">â€”</div>
  </div>

  <div class="row">
    <div class="label">Letzte PrÃ¼fung</div>
    <div class="value" id="letzte">â€”</div>
  </div>

  <div class="row">
    <div class="label">NÃ¤chste PrÃ¼fung</div>
    <div class="value" id="naechste">â€”</div>
  </div>

  <!-- Debug wird nur gefÃ¼llt, wenn etwas schief lÃ¤uft -->
  <div class="row">
    <div class="label">Debug</div>
    <div class="value" id="debug">â€”</div>
  </div>

  <footer>Digitale PrÃ¼fplakette Â· ISM Gruppe</footer>
</div>

<script>
(async function () {
  const elStatus = document.getElementById("statusBox");
  const elId = document.getElementById("assetId");
  const elTyp = document.getElementById("typ");
  const elWll = document.getElementById("wll");
  const elLetzte = document.getElementById("letzte");
  const elNaechste = document.getElementById("naechste");
  const elDebug = document.getElementById("debug");

  function dbg(msg) {
    if (elDebug) elDebug.textContent = msg || "â€”";
  }

  if (!elStatus || !elId || !elTyp || !elWll || !elLetzte || !elNaechste) {
    document.body.innerHTML =
      "<div style='padding:16px;font-family:Arial'>Fehler: HTML-IDs fehlen (statusBox, typ, wll, assetId, letzte, naechste).</div>";
    return;
  }

  function setStatus(raw) {
    const s = (raw || "").toString().trim().toLowerCase();
    elStatus.classList.remove("ok", "bad");

    if (s === "ok") {
      elStatus.classList.add("ok");
      elStatus.textContent = "ðŸŸ¢ Betriebssicher";
    } else if (s === "fÃ¤llig" || s === "faellig") {
      elStatus.classList.add("bad");
      elStatus.textContent = "ðŸŸ¡ PrÃ¼fung fÃ¤llig";
    } else if (s === "gesperrt") {
      elStatus.classList.add("bad");
      elStatus.textContent = "ðŸ”´ Gesperrt";
    } else {
      elStatus.classList.add("bad");
      elStatus.textContent = "ðŸ”´ Status unbekannt";
    }
  }

  function detectDelimiter(line) {
    const semi = (line.match(/;/g) || []).length;
    const comma = (line.match(/,/g) || []).length;
    return semi >= comma ? ";" : ",";
  }

  function normHeader(s) {
    // BOM entfernen + trim + lower
    return (s || "").toString().replace(/^\uFEFF/, "").trim().toLowerCase();
  }

  function parseCSV(text) {
    const lines = text.replace(/\r/g, "").split("\n").map(l => l.trim()).filter(Boolean);
    if (lines.length < 2) return [];

    const delim = detectDelimiter(lines[0]);
    const headers = lines[0].split(delim).map(h => normHeader(h));

    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(delim).map(c => c.trim());
      const row = {};
      headers.forEach((h, idx) => row[h] = (cols[idx] ?? "").trim());
      rows.push(row);
    }
    return rows;
  }

  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");

  if (!id) {
    elId.textContent = "â€”";
    elTyp.textContent = "Bitte URL mit ?id=... Ã¶ffnen";
    elWll.textContent = "â€”";
    elLetzte.textContent = "â€”";
    elNaechste.textContent = "â€”";
    setStatus("fÃ¤llig");
    dbg("Beispiel: ?id=4711");
    return;
  }

  elId.textContent = id;
  dbg("â€”");

  try {
    // Robust: CSV relativ zur aktuellen Seite laden (funktioniert sicher auf GitHub Pages)
    const csvUrl = new URL("Anschlagmittel.csv", window.location.href).toString();

    const res = await fetch(csvUrl, { cache: "no-store" });
    if (!res.ok) throw new Error("CSV nicht gefunden: " + res.status + " (" + csvUrl + ")");

    const csvText = await res.text();
    const rows = parseCSV(csvText);

    // Spaltennamen aus deiner CSV (nach normHeader):
    // serviceartikel-nr | status | typ | tragfÃ¤higkeit | letzte prÃ¼fung | nÃ¤chste prÃ¼fung
    const asset = rows.find(r => (r["serviceartikel-nr"] || "") === id);

    if (!asset) {
      elTyp.textContent = "Unbekannt (ID nicht gefunden)";
      elWll.textContent = "â€”";
      elLetzte.textContent = "â€”";
      elNaechste.textContent = "â€”";
      setStatus("gesperrt");
      dbg("ID nicht in CSV gefunden: " + id);
      return;
    }

    elTyp.textContent = asset["typ"] || "â€”";
    elWll.textContent = asset["tragfÃ¤higkeit"] || "â€”";
    elLetzte.textContent = asset["letzte prÃ¼fung"] || "â€”";
    elNaechste.textContent = asset["nÃ¤chste prÃ¼fung"] || "â€”";
    setStatus(asset["status"] || "gesperrt");
    dbg("OK (CSV geladen)");
  } catch (e) {
    elTyp.textContent = "Fehler beim Laden der CSV";
    elWll.textContent = "â€”";
    elLetzte.textContent = "â€”";
    elNaechste.textContent = "â€”";
    setStatus("gesperrt");
    dbg((e && e.message) ? e.message : String(e));
    console.error(e);
  }
})();
</script>

</body>
</html>
