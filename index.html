<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Digitale PrÃ¼fplakette</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; margin:0; padding:0; }
    .card { max-width:420px; margin:30px auto; background:#fff; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1); padding:20px; }
    .status { font-size:22px; font-weight:bold; padding:12px; border-radius:8px; text-align:center; margin-bottom:20px; }
    .ok { background:#e6f4ea; color:#137333; }
    .bad { background:#fdecea; color:#a50e0e; }
    .row { margin-bottom:10px; }
    .label { color:#666; font-size:14px; }
    .value { font-size:16px; }
    footer { margin-top:20px; font-size:12px; color:#888; text-align:center; }
    .hint { font-size:13px; color:#666; margin-top:10px; }
  </style>
</head>
<body>

<div class="card">
  <div class="status ok" id="statusBox">ðŸŸ¢ Betriebssicher</div>

  <div class="row">
    <div class="label">Anschlagmittel</div>
    <div class="value" id="typ">â€”</div>
  </div>

  <div class="row">
    <div class="label">TragfÃ¤higkeit (WLL)</div>
    <div class="value" id="wll">â€”</div>
  </div>

  <div class="row">
    <div class="label">Serviceartikel-Nr.</div>
    <div class="value" id="assetId">â€”</div>
  </div>

  <div class="row">
    <div class="label">Letzte PrÃ¼fung</div>
    <div class="value" id="letzte">â€”</div>
  </div>

  <div class="row">
    <div class="label">NÃ¤chste PrÃ¼fung</div>
    <div class="value" id="naechste">â€”</div>
  </div>

  <div class="hint" id="hint"></div>

  <footer>
    Digitale PrÃ¼fplakette Â· ISM Gruppe
  </footer>
</div>

<script>
(function () {
  const elStatus = document.getElementById("statusBox");
  const elId = document.getElementById("assetId");
  const elTyp = document.getElementById("typ");
  const elWll = document.getElementById("wll");
  const elLetzte = document.getElementById("letzte");
  const elNaechste = document.getElementById("naechste");
  const elHint = document.getElementById("hint");

  // Falls irgendwas fehlt: nicht abstÃ¼rzen, sondern Hinweis anzeigen
  if (!elStatus || !elId || !elTyp || !elWll || !elLetzte || !elNaechste) {
    document.body.innerHTML = "<div style='padding:20px;font-family:Arial'>Fehler: HTML-IDs fehlen (statusBox/assetId/typ/wll/letzte/naechste).</div>";
    return;
  }

  function setHint(msg) { elHint.textContent = msg || ""; }

  function setStatus(raw) {
    const s = (raw || "").toString().trim().toLowerCase();
    elStatus.classList.remove("ok", "bad");

    if (s === "ok") {
      elStatus.classList.add("ok");
      elStatus.textContent = "ðŸŸ¢ Betriebssicher";
    } else if (s === "fÃ¤llig" || s === "faellig") {
      elStatus.classList.add("bad");   // (spÃ¤ter kÃ¶nnen wir gelb ergÃ¤nzen)
      elStatus.textContent = "ðŸŸ¡ PrÃ¼fung fÃ¤llig";
    } else if (s === "gesperrt" || s === "blocked") {
      elStatus.classList.add("bad");
      elStatus.textContent = "ðŸ”´ Gesperrt";
    } else {
      elStatus.classList.add("bad");
      elStatus.textContent = "ðŸ”´ Status unbekannt";
    }
  }

  // CSV Parser: erkennt automatisch ; oder ,
  function detectDelimiter(headerLine) {
    const semi = (headerLine.match(/;/g) || []).length;
    const comma = (headerLine.match(/,/g) || []).length;
    return semi >= comma ? ";" : ",";
  }

  function splitLine(line, delim) {
    // einfach & robust genug fÃ¼r normale Excel-CSV
    return line.split(delim).map(x => x.trim());
  }

  function normalizeHeader(h) {
    return (h || "")
      .toString()
      .trim()
      .toLowerCase()
      .replace(/\uFEFF/g, ""); // BOM entfernen
  }

  function parseCSV(text) {
    const cleaned = text.replace(/\r/g, "").trim();
    const lines = cleaned.split("\n").map(l => l.trim()).filter(Boolean);
    if (lines.length < 2) return { rows: [], delim: ";" };

    const delim = detectDelimiter(lines[0]);
    const headers = splitLine(lines[0], delim).map(normalizeHeader);

    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      const cols = splitLine(lines[i], delim);
      const row = {};
      headers.forEach((h, idx) => row[h] = (cols[idx] ?? "").trim());
      rows.push(row);
    }
    return { rows, delim };
  }

  async function main() {
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");

    if (!id) {
      elId.textContent = "â€”";
      elTyp.textContent = "Bitte URL mit ?id=... Ã¶ffnen";
      setStatus("fÃ¤llig");
      setHint("Beispiel: ?id=4711");
      return;
    }

    elId.textContent = id;
    setHint("");

    try {
      // WICHTIG: Dateiname exakt wie im Repo (GroÃŸ-/Kleinschreibung!)
      const res = await fetch("./Anschlagmittel.csv?ts=" + Date.now());
      if (!res.ok) throw new Error("CSV nicht gefunden: " + res.status);

      const csvText = await res.text();
      const { rows } = parseCSV(csvText);

      // Spaltennamen aus deinem Screenshot:
      // "Serviceartikel-NR", "status", "typ", "TragfÃ¤higkeit", "letzte PrÃ¼fung", "nÃ¤chste PrÃ¼fung"
      const asset = rows.find(r => (r["serviceartikel-nr"] || "") === id);

      if (!asset) {
        elTyp.textContent = "Unbekannt (ID nicht gefunden)";
        elWll.textContent = "â€”";
        elLetzte.textContent = "â€”";
        elNaechste.textContent = "â€”";
        setStatus("gesperrt");
        setHint("ID nicht in CSV gefunden.");
        return;
      }

      elTyp.textContent = asset["typ"] || "â€”";
      elWll.textContent = asset["tragfÃ¤higkeit"] || "â€”";
      elLetzte.textContent = asset["letzte prÃ¼fung"] || "â€”";
      elNaechste.textContent = asset["nÃ¤chste prÃ¼fung"] || "â€”";
      setStatus(asset["status"]);

    } catch (e) {
      elTyp.textContent = "Fehler beim Laden der CSV";
      elWll.textContent = "â€”";
      elLetzte.textContent = "â€”";
      elNaechste.textContent = "â€”";
      setStatus("gesperrt");
      setHint(String(e));
      console.error(e);
    }
  }

  main();
})();
</script>

</body>
</html>
