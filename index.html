<script>
(async function () {
  const elStatus = document.getElementById("statusBox");
  const elId = document.getElementById("assetId");
  const elTyp = document.getElementById("typ");
  const elWll = document.getElementById("wll");
  const elLetzte = document.getElementById("letzte");
  const elNaechste = document.getElementById("naechste");

  if (!elStatus || !elId || !elTyp || !elWll || !elLetzte || !elNaechste) {
    document.body.innerHTML = "<div style='padding:16px;font-family:Arial'>Fehler: HTML-IDs fehlen (statusBox, typ, wll, assetId, letzte, naechste).</div>";
    return;
  }

  function setStatus(raw) {
    const s = (raw || "").toString().trim().toLowerCase();
    elStatus.classList.remove("ok", "bad");

    if (s === "ok") {
      elStatus.classList.add("ok");
      elStatus.textContent = "ðŸŸ¢ Betriebssicher";
    } else if (s === "fÃ¤llig" || s === "faellig") {
      elStatus.classList.add("bad");
      elStatus.textContent = "ðŸŸ¡ PrÃ¼fung fÃ¤llig";
    } else if (s === "gesperrt") {
      elStatus.classList.add("bad");
      elStatus.textContent = "ðŸ”´ Gesperrt";
    } else {
      elStatus.classList.add("bad");
      elStatus.textContent = "ðŸ”´ Status unbekannt";
    }
  }

  function detectDelimiter(line) {
    const semi = (line.match(/;/g) || []).length;
    const comma = (line.match(/,/g) || []).length;
    return semi >= comma ? ";" : ",";
  }

  function norm(s) {
    return (s || "").toString().replace(/^\uFEFF/, "").trim().toLowerCase();
  }

  function parseCSV(text) {
    const lines = text.replace(/\r/g, "").split("\n").map(l => l.trim()).filter(Boolean);
    if (lines.length < 2) return [];

    const delim = detectDelimiter(lines[0]);
    const headers = lines[0].split(delim).map(h => norm(h));

    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(delim).map(c => c.trim());
      const row = {};
      headers.forEach((h, idx) => row[h] = (cols[idx] ?? "").trim());
      rows.push(row);
    }
    return rows;
  }

  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");

  if (!id) {
    elId.textContent = "â€”";
    elTyp.textContent = "Bitte URL mit ?id=... Ã¶ffnen";
    elWll.textContent = "â€”";
    elLetzte.textContent = "â€”";
    elNaechste.textContent = "â€”";
    setStatus("fÃ¤llig");
    return;
  }

  elId.textContent = id;

  try {
    // Dateiname exakt wie im Repo: Anschlagmittel.csv
    // Repo-Name automatisch aus der URL holen (bei GitHub Pages: /<repo>/...)
    const repo = location.pathname.split("/")[1];  // z.B. "nfc-test"
    const csvUrl = `${location.origin}/${repo}/Anschlagmittel.csv`;

    const res = await fetch(csvUrl, { cache: "no-store" });
    if (!res.ok) throw new Error("CSV nicht gefunden: " + res.status + " (" + csvUrl + ")");
    const csvText = await res.text();

    const rows = parseCSV(csvText);

    // Spaltennamen exakt wie bei dir:
    // Serviceartikel-NR | status | typ | TragfÃ¤higkeit | letzte PrÃ¼fung | nÃ¤chste PrÃ¼fung
    const asset = rows.find(r => (r["serviceartikel-nr"] || "") === id);

    if (!asset) {
      elTyp.textContent = "Unbekannt (ID nicht gefunden)";
      elWll.textContent = "â€”";
      elLetzte.textContent = "â€”";
      elNaechste.textContent = "â€”";
      setStatus("gesperrt");
      return;
    }

    elTyp.textContent = asset["typ"] || "â€”";
    elWll.textContent = asset["tragfÃ¤higkeit"] || "â€”";
    elLetzte.textContent = asset["letzte prÃ¼fung"] || "â€”";
    elNaechste.textContent = asset["nÃ¤chste prÃ¼fung"] || "â€”";
    setStatus(asset["status"]);
  } catch (e) {
    elTyp.textContent = "Fehler beim Laden der CSV";
    elWll.textContent = "â€”";
    elLetzte.textContent = "â€”";
    elNaechste.textContent = "â€”";
    setStatus("gesperrt");
    console.error(e);
  }
})();
</script>


