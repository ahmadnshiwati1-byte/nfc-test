<script>
  const elStatus = document.getElementById("statusBox");
  const elId = document.getElementById("assetId");
  const elTyp = document.getElementById("typ");
  const elWll = document.getElementById("wll");
  const elLetzte = document.getElementById("letzte");
  const elNaechste = document.getElementById("naechste");

  function setStatus(raw) {
    const s = (raw || "").toLowerCase().trim();
    elStatus.classList.remove("ok", "bad");

    if (s === "ok") {
      elStatus.classList.add("ok");
      elStatus.textContent = "ðŸŸ¢ Betriebssicher";
    } else if (s === "fÃ¤llig" || s === "faellig") {
      elStatus.classList.add("bad");
      elStatus.textContent = "ðŸŸ¡ PrÃ¼fung fÃ¤llig";
    } else {
      elStatus.classList.add("bad");
      elStatus.textContent = "ðŸ”´ Gesperrt";
    }
  }

  function parseCSV(text) {
    const lines = text.replace(/\r/g, "").split("\n").filter(l => l.trim());
    const headers = lines[0].split(";").map(h => h.trim().toLowerCase());
    const rows = [];

    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(";").map(c => c.trim());
      const row = {};
      headers.forEach((h, idx) => row[h] = cols[idx] || "");
      rows.push(row);
    }
    return rows;
  }

  async function main() {
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");

    if (!id) {
      elTyp.textContent = "Bitte URL mit ?id=...";
      setStatus("fÃ¤llig");
      return;
    }

    elId.textContent = id;

    try {
      // HIER: dein Dateiname
      const res = await fetch("Anschlagmittel.csv?ts=" + Date.now());
      if (!res.ok) throw new Error("CSV nicht gefunden");

      const csv = await res.text();
      const rows = parseCSV(csv);

      const asset = rows.find(r => r["serviceartikel-nr"] === id);

      if (!asset) {
        elTyp.textContent = "Unbekanntes Anschlagmittel";
        setStatus("gesperrt");
        return;
      }

      elTyp.textContent = asset["typ"] || "â€”";
      elWll.textContent = asset["tragfÃ¤higkeit"] || "â€”";
      elLetzte.textContent = asset["letzte prÃ¼fung"] || "â€”";
      elNaechste.textContent = asset["nÃ¤chste prÃ¼fung"] || "â€”";
      setStatus(asset["status"]);

    } catch (e) {
      elTyp.textContent = "Fehler beim Laden der CSV";
      setStatus("gesperrt");
      console.error(e);
    }
  }

  main();
</script>
